<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="/static/css/map.css">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Функция переключения сенсоров в попапе
    function switchThing(containerId, thingId) {
        document.querySelectorAll('#' + containerId + ' .thing-metrics').forEach(el => el.style.display = 'none');
        const shown = document.getElementById('metrics-thing-' + thingId);
        if (shown) shown.style.display = 'block';
        document.querySelectorAll('#' + containerId + ' .dash-btn').forEach(el => el.style.display='none');
        const btn = document.getElementById('btn-thing-' + thingId);
        if (btn) btn.style.display='inline-block';
    }

    // Ручное управление аккордеоном слоев
    function toggleGisAccordion(btn, targetId) {
        const el = document.getElementById(targetId);
        if (!el) return;
        if (window.bootstrap && window.bootstrap.Collapse) {
            const bsCollapse = bootstrap.Collapse.getOrCreateInstance(el, {toggle: false});
            bsCollapse.toggle();
        } else {
            if (el.classList.contains('show')) {
                el.classList.remove('show');
            } else {
                el.classList.add('show');
            }
        }
        if (btn.classList.contains('collapsed')) {
            btn.classList.remove('collapsed');
            btn.setAttribute('aria-expanded', 'true');
        } else {
            btn.classList.add('collapsed');
            btn.setAttribute('aria-expanded', 'false');
        }
    }
</script>

<div class="gis-control-wrap">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Слои карты</h5>
        <span class="toggle-gis-btn text-primary" style="cursor:pointer;" onclick="document.getElementById('gis-body').style.display = document.getElementById('gis-body').style.display === 'none' ? 'block' : 'none'">
            <i class="bi bi-list"></i>
        </span>
    </div>
    
    <div id="gis-body">
        <div class="mb-3">
            <label class="form-label small fw-bold">Растровый фон</label>
            <select id="raster-select" class="form-select form-select-sm mb-2">
                <option value="">— нет —</option>
                {% for r in raster_layers %}
                <option value="{{ r.schema }}.{{ r.name }}">{{ r.title }}</option>
                {% endfor %}
            </select>
            
            <label for="raster-opacity" class="form-label small text-muted mb-0 d-flex justify-content-between">
                <span>Прозрачность слоя</span>
                <span id="opacity-val">70%</span>
            </label>
            <input type="range" id="raster-opacity" class="form-range" min="0" max="1" step="0.1" value="0.7" 
                   oninput="document.getElementById('opacity-val').innerText = Math.round(this.value * 100) + '%'"/>

            <div id="raster-legend-container" class="mt-3 p-2 bg-light border rounded" style="display: none;">
                <div class="d-flex justify-content-between align-items-center small mb-1">
                    <span id="legend-min" class="fw-bold text-muted">0</span>
                    <span id="legend-unit" class="text-secondary" style="font-size: 0.8em;"></span>
                    <span id="legend-max" class="fw-bold text-muted">100</span>
                </div>
                <div id="legend-bar" style="height: 12px; border-radius: 6px; width: 100%; border: 1px solid #ccc;"></div>
            </div>
        </div>

        <hr class="my-2">

        <label class="form-label small fw-bold mb-2">Векторные данные</label>
        
        <div class="mb-2">
            {% for layer in vector_presentation.layers %}
            <div class="form-check vector-item">
                <input class="form-check-input vector-checkbox" type="checkbox" 
                       id="v-{{ layer.table }}"
                       data-table="{{ layer.table }}"
                       data-color="{{ layer.color }}"
                       data-label="{{ layer.label }}">
                <label class="form-check-label d-flex align-items-center" for="v-{{ layer.table }}">
                    <span class="color-dot me-2" style="background-color: {{ layer.color }}; width: 12px; height: 12px; border-radius: 50%; display: inline-block;"></span>
                    {{ layer.label }}
                </label>
            </div>
            {% endfor %}
        </div>

        <div class="accordion accordion-flush" id="gisUniqueAccordion">
            {% for group in vector_presentation.groups %}
            <div class="accordion-item" style="border: none;">
                <h2 class="accordion-header" id="gis-heading-{{ loop.index }}">
                    <button class="accordion-button collapsed py-2 px-0 shadow-none" 
                            type="button" 
                            onclick="toggleGisAccordion(this, 'gis-group-{{ loop.index }}')"
                            aria-expanded="false">
                        {{ group.name }}
                    </button>
                </h2>
                <div id="gis-group-{{ loop.index }}" class="accordion-collapse collapse">
                    <div class="accordion-body px-0 py-1">
                        {% for item in group.options %}
                        <div class="form-check vector-item">
                            <input class="form-check-input vector-checkbox" type="checkbox" 
                                   id="v-{{ group.table }}-{{ group.column }}-{{ item.val }}"
                                   data-table="{{ group.table }}"
                                   data-col="{{ group.column }}"
                                   data-val="{{ item.val }}"
                                   data-color="{{ item.color }}"
                                   data-label="{{ item.label }}">
                            <label class="form-check-label d-flex align-items-center" for="v-{{ group.table }}-{{ group.column }}-{{ item.val }}">
                                <span class="color-dot me-2" style="background-color: {{ item.color }}; width: 12px; height: 12px; border-radius: 50%; display: inline-block;"></span>
                                {{ item.label }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
    </div>
</div>

<style>
.vector-item {
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}
.accordion-button {
    font-size: 0.95rem;
    font-weight: 600;
    background-color: transparent !important;
}
.accordion-button:not(.collapsed) {
    color: var(--bs-primary);
    box-shadow: none;
}
.accordion-button::after {
    transform: scale(0.8);
}
</style>