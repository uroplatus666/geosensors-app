# Визуализация данных с двух Frost Servers
 
-Flask-приложение было развернуто с помощью Yandex Cloud, Serverless Containers
Веб-приложение на Flask, которое собирает данные с двух серверов [OGC SensorThings API](https://www.ogc.org/standards/sensorthings) и визуализирует их на интерактивной карте с дашбордом. Источники данных:

Демонстрационный развёрнутый экземпляр: <https://bbau4bc4rnl6lkjbklbp.containers.yandexcloud.net/>

## Возможности

- интерактивная карта на базе Folium со слоями для каждого сервера SensorThings;
- попапы с переключением MultiDatastreams / Datastreams и ссылками на подробный дашборд;
- подготовка временных рядов и расчёт розы ветров по данным сервера РУДН;
- API `/api/data/<sensor_key>` для фронтенда дашборда и сторонних клиентов;
- готовые HTML-дашборды с графиками Plotly и карточками последних измерений;
- служебный `/healthz` для систем оркестрации.

## Структура репозитория

```
.
├── Dockerfile         # Образ для продакшена (Gunicorn  uv)
├── compose.yml        # Docker Compose со сборкой и прокидыванием окружения
├── hse_geosensors.py  # Основной модуль приложения и все обработчики
├── pyproject.toml     # Зависимости и метаданные проекта
├── uv.lock            # Замороженные версии для uv
└── README.md          # Вы читаете этот файл
```

## Быстрый старт локально

1. Установите Python ≥ 3.10 и [uv](https://github.com/astral-sh/uv) (рекомендуется).
2. Клонируйте репозиторий и установите зависимости:

   ```bash
   uv sync
   ```

   Альтернатива без uv:

   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -e .
   ```

3. Запустите приложение:

   ```bash
   uv run python hse_geosensors.py
   ```

   Сервер по умолчанию поднимется на `http://127.0.0.1:8080/`.

Во время разработки можно включить перезапуск при изменениях, задав `FLASK_ENV=development` и запустив через Flask CLI:

```bash
uv run flask --app hse_geosensors:app run --debug --port 8080
```

## Переменные окружения

| Переменная        | Назначение                                                                 | Значение по умолчанию |
|-------------------|----------------------------------------------------------------------------|------------------------|
| `RUDN_BASE_URL`   | Базовый URL SensorThings API РУДН                                         | `http://94.154.11.74/frost/v1.1` |
| `OTHER_BASE_URL`  | Базовый URL второго сервера SensorThings                                  | `http://90.156.134.128:8080/FROST-Server/v1.1` |
| `REQUEST_TIMEOUT` | Таймаут HTTP-запросов к API (секунды)                                      | `300` |
| `PORT`            | Локальный порт для Flask (и Gunicorn в Docker)                            | `8080` |
| `FLASK_ENV`       | Режим Flask (`development` включает автоперезапуск и debug-инструменты)   | `production` |
| `GUNICORN_*`      | Тюнниг воркеров/потоков Gunicorn при запуске в контейнере                 | см. `Dockerfile` |

Добавьте файл `.env`, чтобы переопределить значения при локальном запуске или через Compose.

## Запуск в Docker

```bash
docker compose --env-file .env up --build
```

Ожидается, что в `.env` определены `IMAGE`, `TAG` и (опционально) переменные из таблицы выше. Контейнер слушает порт `8080` и пробрасывается наружу через `HOST_PORT` (по умолчанию 18080).

## API

- `GET /` — интерактивная карта с маркерами локаций и ссылками на дашборды.
- `GET /dashboard/<sensor_key>` — HTML-дашборд конкретного сенсора с графиками Plotly.
- `GET /api/data/<sensor_key>?metrics=[...]&range=7d&agg=1h` — данные для построения графиков (временные ряды и роза ветров). Ответ формируется на основе кэша `dashboard_data`, наполняемого при открытии карты.
- `GET /healthz` — служебная проверка «живости» приложения.

`sensor_key` соответствует идентификатору, который формируется для MultiDatastream/Datastream внутри попапов карты (например, `MD__12345` или `DS__thingId__datastreamId`).

## Разработка и расширение

- Основная логика работы с SensorThings и подготовка данных сосредоточена в `hse_geosensors.py`.
- Вспомогательные функции для обработки координат, агрегации временных рядов и расчёта ветра задокументированы и могут переиспользоваться в новых обработчиках.
- Для добавления новых источников данных обновите блоки конфигурации (палитра, целевые показатели) и логику наполнения `dashboard_data` в обработчике `root_map`.
